async function combineKeys(keys){
    keys = keys.sort()
    key = await sha256_raw(keys.join(""))
    return key
}

async function sha256_raw(message) {
    const msgBuffer = new TextEncoder().encode(message);                    
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray
}

function xor(arr1, arr2){
    return arr1.map(function(e, i) {return e^arr2[i];});
}

function hexToBytes(hex) {
    let bytes = [];
    for (let c = 0; c < hex.length; c += 2)
        bytes.push(parseInt(hex.substr(c, 2), 16));
    return bytes;
}

function bytesToHex(bytes) {
    let hex = [];
    for (let i = 0; i < bytes.length; i++) {
        let current = bytes[i] < 0 ? bytes[i] + 256 : bytes[i];
        hex.push((current >>> 4).toString(16));
        hex.push((current & 0xF).toString(16));
    }
    return hex.join("");
}

async function tryKey(key){
    for (potential of potentials){
        potential = hexToBytes(potential);
        guess = xor(key, potential);
        hash = await sha256(bytesToHex(guess));
        if (valids.includes(hash)){
            return bytesToHex(guess);
        }
    }
    return 0;
}

function disallowMeta(keynum){
    metaBody = document.getElementById("metadiv")
    if (keynum == 6) {
        metaBody.innerHTML = `<h3>sorry, you can't see the meta until you have solved ${7 - keynum} more puzzle</h3>`
    } else if (keynum < 7){
        metaBody.innerHTML = `<h3>sorry, you can't see the meta until you have solved ${7 - keynum} more puzzles</h3>`
    } else {
        metaBody.innerHTML = "<h3>hmm, you seem to have broken something :v</h3>\n<h3>your progress has been reset in an attempt to fix it</h3>"
        setPuzzleToken({});
    }
}

function fetchMeta(text){
    metaBody = document.getElementById("metadiv");
    metaBody.innerHTML = text;
}

async function unlockMeta() {
    token = loadPuzzleToken();
    keys = [];
    for (i=1;i<=10;i++){
        keyFragment = token[i]
        if (keyFragment != undefined){
            keys.push(keyFragment[1]);
        }
    }
    if (keys.length < 7){
        disallowMeta(keys.length);
    }
    else {
        finalKey = await combineKeys(keys);
        resultURL = await tryKey(finalKey);
        if (resultURL != 0){
            resultURL = window.location.href + resultURL + ".html";
            console.log(`meta unlocked with url ${resultURL}`)
            fetch(resultURL)
            .then(response => response.text())
            .then(text => fetchMeta(text))
        }
        else {
            disallowMeta(keys.length)
        }
    }
}

valids = ['2562bba0f3a1c8d609ca9fee6ff628f5c3365dbb8bbfb79546f986dd0097ce26', 'a6c0d271d143ab3595e217f707c10f77218c93e9e142c651a0f09847f5681fae', '764d9a8ce3a8366d9bb8d1aa61197737869d0b23a4428bd917b1a8cf7cbd5c67', 'e0456cd822b0f68e2a4e9025a0f98b389bcd909ccfe0b35cc21967880bcef377']

potentials = ['444e558a69ad141393f4e4e3484a042673880b37320e6980a90229b888784ed4',
 '9828036512486686317e0bdc5a839441c826091fad27bd8d455f464d8370dc16',
 '4607ad25a4ffdd8aed7f987a736710a20772c7fbdbe239a8bd842089b4851541',
 '73fcb5acfb2bf907155a3bf6f9ddec48a8b76a52837e197089b86e1ebab5a11f',
 'b15c9a03f231563ec2a3e475a677b1ae0cc3f3fb0e09ce4bf2523b8dadb5165a',
 'cfe01870330a166406b554d779a320c82178f4ef1c74a9e074deda85c4668228',
 'e5f9c5f4f2c59a8c5c31edec2c34ff566b1f11a4d727dcae48ef50dd59359730',
 'a343f877498a17a88721e18fe3a05b854a33d3da033464b574d6ef3e7b3587b2',
 '8192b93e9ad9fbddba5c16607282ee8abb8f2672a2765352dfea61f328afcd01',
 'e8017d1cca1020efc71b8c8e01f692c3f6cd3b21501ff6014e696de9e590812c',
 '7deea610bcf3062b04dfaf432285960d89a902628cf0f45aa8a5cf448a7d741c',
 '727f68668ad6fa10898dcac4b9ff068b63e337a1b8dc56724b6515fc58750cda',
 'da6e75c8416ed33e7e6f17a54b9d18085ddceba2948197c69b1d527740c8168e',
 'a9203b7b8123cdfad22d68265b628ac6e429e96b6daacefb820cdcf13cc22cda',
 '3ee93087b65b6446f16f17363342610ec2f5c2715e2c5ea76d6ef2dc5703613d',
 'd6606175d49df8aae5f58d8fe2522fb8cf767a5b1b99225fbdacf8d86487c74e',
 '85dc46bc8e81cdadf5cb56006442b4d399b233dbd1c27e4589a0df4628458f48',
 '20ad5908f3f23fbd7092393453cab6551fc72be4654294a371f0c38cb2bd38a7',
 '18da2ec43d543ea02591ef301abd469b4cbff674b17858668f507e4196681f00',
 'f0f8d8dac68a2de336c95a2ad217bde39766cb825b5fff4c5f4ab55a3f25e6bd',
 '4879540bc3d7f6ada33f12826638194b211029ceb9e6e2008714a96e92dafaef',
 '7da8d6af3570fe159f97da8f58ccc4e4e0108e2985e075cc50acad1ef808fab6',
 'ebae977751e6d3bfa2f17e8921beb62ff9de6df70b51b3e82ba89bc6f763c202',
 '47739e6f938604a452c6a51d06b4efd1e6f84cc68a02a85c338bfee81f45b5fd',
 'd05f60162189e04c7f75b817b75b5d46054476074960cdef226844a7020abe05',
 'a5033a945332d737ee694c765201140c7a1a9ebb01500a4f756d59897f470bf3',
 '9c5920d8d15273cfdddf45c02eab15caa77c8d6fe8848479b8ed0b85d3a49645',
 '1df1a467c31b5c3342bb9edb8d4a0446fc12ea9b43309d8751cfd2ff485f8ac6',
 'b8805bfb6bf02f09576be4b1a92e60bf0dc50523f2492d89482feace832e1182',
 '5db7f5973e89c76e15869e00323a092f84feed8ada9ede3e26ce5cc2ee7f7cdc',
 '421b22cc36280b6750b0b68b490683fec1405d56d919232909bb3fb6cb3ae90c',
 '4a4f07785e0f3c55a66a1aeac2907f1c6a1cc756b982bc22b32baa431cffd385',
 '439ca319c89bc30eeb69958e89973163bd2c9936e7ee37f6d15ecf36688ed80d',
 '3d0dcf5ee4419089c3ede25036715fa59f5996b85ffac18985689394e72fc692',
 '8c3abc3d19eb7c62f82d0d1e37131a3866cc69314f2c9d4a954a2a62f2bf4efa',
 '8171951828a3e454f2697f21d3c2ede8c6fcd9f6774aacb06ce36e2fc6478577',
 'da8fdc29d5f166c93ba07882c4427323ebe99dbdbb69f76ad8cfe725b39e2579',
 '1b8969748a3211f5997e75843e3068ee1959c677813485f7b3becd37cd5b2378',
 '28ec661196228d91b12cccd183043d58ece3c96b3cd466f7a98fbe6f02dd62ad',
 '5cc781fa6a95d2510fad8b87e6ed5a09b126de1a81d564e6e321c55aa1f9b63e',
 'f50cbaa60cb8c1cfb8e8c41430c23884a703018e9bffc1a4ee490974cd2e4fad',
 'a390916cb3c2befa901973ba73c4be1f42032671e2c7c76b91ae97e8d41b4ed6',
 '0c312d879e5838fba0f86c4b6fa5ba6b544f89984d27086e33bd4fc145716d19',
 '5bbb0e3853b451014e29e13ef01668e0129ea23277a33aeb14f2b1bd3df770de',
 'd0ac3ff1a544316b924217ed6ef84c2a2430981c9ed6d0ec3efeab355115cf96',
 '1ad89d4565e64981b9513fd2eaed49b40b17e37ae07f7b66acedb32aa0421610',
 'a87d834a85f50dc314be4c792d2ef45c5e5290124038886c4f7ea85fe4f1f79b',
 'ca4c87808fa2ea1fe03463852ae2d71feaf2def176156943e94ebb8e567375be',
 '179d23d36515ac0a5e11b96c1a0fd41b3908ac7d7524ca3d2a39a1bd120082b6',
 'dfdf40d6b0bca4b566674fdcc3d17a2356f62d116cd5e261bdba791f7f81599b',
 '4d56bed63b394dab6e735c761bafed700aa16ff8f547836757a11cd38fe6ed87',
 'ada1ba712e7b3393d30c095c790bed9dc9d0770b40670f26582e7bd30fdfd2e1',
 'cdb08eaf900353b206c0d4047fca29ef3c66b37e4aca846f17ec22e0b7c5ecce',
 '2181ebd8290251772f73f2d5dca6dd53db7b68f730f6fb5478447e68199568cc',
 'baf20f21a2fffbdec19dee1891fefabd05cc273997afbebe4bd7fd4eea2f4554',
 '4c3ce2bf6e37bc0c46ffc242113eebb699ae3d4612bde1da5aaa6989300d2f22',
 'df0ed75b16aca68fb752902f0a57263bb164c5e0c0a8761ec191844cba5b36d6',
 '4684845d17a41289ae43fe00fa70fa3535999c10cd2362f526ff403c4441e97c',
 '6216578d87c46fbe07d4cd3db13b84786b727faf53fdb9dfc3782f1f4a5d452a',
 '8c89eb6b5d69a52ca1b5c6fa041db80facc29003846c52325fe0e1335a64ec34',
 '896b45329ca5f97f5c7d8db07828c63db4368b54d4c16d73e445d44a8cfbcef1',
 'f45332dfdb2d9662dcab0873f3d4d82a864391adb6825530332bc097504087b4',
 '3956a8a5db8a3da3948a132c55a2211937a1b8d638e299f286b8ccbdaf095aec',
 '5e3b22386807ee334c99ca0474a4e2c2545a179232b4265df69d3bee13fed9fc',
 'a05d3089ed97ec62e967ebb4979abe7ac44998810cdb25ca55ad43c16b7484f0',
 '89858d50acac4f5795acb1039295f8ce782430cc32fe82fc0b4fcaaf90c62d66',
 '95119921d69309c4bafe14b1585a88b319bb98b069a6280785b8c9ad31ce7fc4',
 '4c7f12de359390629031df685e04e1b441b9f4fe327fb9479214243b7493add8',
 '8efdaf25a6ff05e2eef72b0c7a39f596631b7032f48ce89f0e7fefca3503de3b',
 '6885baf0d377b5135f4c121fe6295803013deb3a62c9ddee4db059ed5146d3e8',
 '16635af727ae01e62544e07ddc7e12022780c5209a7f45a742e966423dba8738',
 'cad60603d5d0107e7d294b66685319aad9117c71c30a3ea93376bf535844ddde',
 'a458cb3c093a47e590050a153f570c0a737fb518236760609b0500a9fc726bc3',
 'fba1dc10923a6cf80aad878a45710bd3f8af339eb05256bd9303336d84818483',
 '8c4a9c0c987e019923830bdcdac6e2fa9a80d9eb8f6cd7b70a0a29cc7c77af59',
 '5c7c44f85a063ad427e5aef94023ee1fd011432daffe90faf888aa20aaece573',
 '565b2c29de94492e3e0db66abc28bd07bdf3fc19382cf9147fce81e560f4157d',
 'b8fcd707602337ce612d1480deced6fb13000952961c75553ef1955ea0b1a5f9',
 '8ac885c5219f85216343b20f98e63feb4f660c921c580ef5e9511f5b668fadb0',
 '609489d189e91820530a8a3d0313ebe3be94540c1c8cb49a2f2a2c7e005eaeb2',
 '4c53c459f9d1519640c457d3b434911b46eca651ee6f1b11ec990714dd9204d9',
 '401958142dd85249d5fbf43c304ddef15481a8f63975382c170de51c3da33502',
 '2eff5f81aabd6f1d55c91ac247b8bf22fa965229951d51586c6759dc3a860f66',
 '5a840a96c9e90033fdcf01944675f8c577cd7b1a6a1edb9f7f71e2e03b90e1da',
 '1b5a102ac42d963e5b853ee173213e4b9305a5ed3d65f8c6d062e3ed275fa234',
 'f7efd72fe7c5e0c8cdc1115aecc29cd4fbb73a222ca19d7bdcb2b3ffb658515b',
 '30cc900c752b23e195126f91bfaa464625b71825ddbfce2f5d48149fd1055759',
 '2f036df010fdf8b81a3c7044eaa10ec39fa14e8735fbe2ca7a92299fb686e1d6',
 '5b426eaf5abf8880241f12abac45aab790407cc3d5b4d52efa5e36a5fd684c8b',
 'e6c9b4725c141913858644660d734bfb16524edf8a396f6cf87fa84109c30393',
 '8d6f22c3b563098b93e4819b3d47842da23f63e47eade5bfcece2012a751e4e6',
 'ca7168d503685af535a8159880683043cb5cc2a07f0c9711e5cf344c382df77c',
 'f3ec9dc43c8d00e01ea0136f7b63576d61ed08ce88abf0ec53626ebd6b000934',
 '95954c92907f3668f58f322953c905a23e69e5da0634692c9e6c0f642c265c29',
 '4dce3ccca1769fe1660705b03cf1a18a94d8748459c21c0a2c40882e7aee5b27',
 '4513702b2a5f059e21778d523bdb43242896d4807e78b5acba09454c0c6eeaab',
 'e776217788a08246e9d3457b38533ab8ad9f3c44c6af63241a5e7f093dc2517c',
 'c3bfc0453975686c6930ba9eac3cfaf9bfbb7312e21546e248086bc8ae60c45d',
 '2fbf28af5c3510223949855537ee9c0cf71a759f9b96bb3eced21c5062e832fe',
 '131ae929ae9b7e1ecff65a89b6ce844cd5cc3e8933f8435a5c74e878f86c0feb',
 '13b636cf5977de6aa930463cb64918ba64501b416fc64eca6d96041d7c455479',
 'c3786f60ddbd129465e3e55468d2336eaaf24f28f5a9cc7af84765ac5b7c558d',
 'ac568b6dd1d84c307c7565fa2626183fd4c0b8c24ef9654b0a73882eb698282b',
 'cbd727913c453cc54d5a65092fab641ab928f2abe6eff0b2334df42c9b1952c2',
 'b410f1c9685614de965a0ea641207e9e07b72a2555ba117650e78fc524506b99',
 'ffd20cd6c3ce9ce81ebcdd591dd1c33437e7218ccd33ff522fe72eb6d6c2f25f',
 '143c4a79e993ba8d83594b36b1e0a26bef5dd87ce146c3c30f8e1887234c8c60',
 '319e7940018ad6b4fbd9cf884bf0c5fe1e38af6d5aad6a7d662ece123ee90d78',
 'e4199d241d705572d61da474ad09565b9918331a94265381301d591f9bf81816',
 '210a39ae7d656a077c3eeec9b7b8763d4f4b453c3c76a8d15beb45d9c5a8f910',
 'c4eae0d1537db405a3b22f95026b87baf5b65e2f424093337ffaed4a16a838f9',
 '57e6ff018191411da7209dd8ddd6d7acc0ee1dcf1eb0620d97a439880fe62a17',
 'ed0a7abc43e36194a1bf5e1800451c38c1638d76e765852c7d5d0d6efd1b52d8',
 'eb79212ccea090555c800b7be7e834c778776f609d3dab50f35991c727791186',
 '5c68e3924c058d4df9bc6cbfe18eb38cef6162deca6e567d87b8c216ea6b2497',
 '4be10759672baddd393e133d443dea85aabeffa9545fb30b0b04d36fa7497c4a',
 '53ce470c1daa418ebee0b8fb11af2cdea6c5ccc8551014a7f1bfb5d27610cdde',
 '73d036ad126cc7652d8e312371054ac8ce460db58403e005264f7fd1d0ca3771',
 '43350385d911ee369c531bf1309aaedd67195189053ec39584848d85bb1c3327',
 '92578fec6deea0b417e97445b6c918a8834f7db68803b8f9391b7b31c8cee2e3',
 '6516d8003682abaa903999f791d35f497b05a6332d2d5e5257612dd4ce3dd5eb',
 'db3ae0b4ef417c0257f0105b9039ec9c9234f676fcc39d1ae50210dc45fba458',
 '15453ef2ac277ecd53b70da6b46f77dfca2798ff985fc199b7320ba55dd383d9',
 '054584f11a2c507b3455fea5b951654369580c7917f006c0fa7c3b08b4a6e63b',
 '1985d6855b52e9506e33943d4a79dc64b07676e28a56fc7a7e514aa0c05664ab',
 'fa08fdf1f3e234826225ced49239314a70307ccbe85cdb769c26a7d67aeaedcf',
 'd529c57e03caca889d02d64d4a23d54687680fa68e6f4c1867767252dde63053',
 '89da5ca4a036838bda480f9035ae6ec4523fe8b3217f4b4c06d0c1456b808314',
 'fc3f804350f5ee0d91505a10a1eeff81085ff7c325588395a1e855afad6b2c25',
 '68e6196b5d955ea1deeac8ffd8df04c3de3a6ce2b97a7f4327332fc6a11d42bd',
 '2e27e3a828147dbf0cda25b9f92048a17716c24f8db74f78a4c1cf3c68417737',
 'f24f0f3700de4b645bca12dd319722b2fbb88c9750504fb0ae280b9f6403acd5',
 '4979e56ec2f5de420891d6bb501305e120675ab20d6270b2dac6c7fb8f69c067',
 'c4160d25204d14193e06463272827933b7cc6112f801c235321f1701e10fb5ff',
 '381070ee5b275646bc55a0846f267fa624028f1ac6b6b0e88b2df249008a4807',
 '718dce8311f59023c66b4c9878d84c67d0616e738baf03162ed151cf39c5e8a2',
 'd0b1c4dd5986d1d74ace75ef83ee7c55b14e746eebfea0976457d58175151d31',
 '3b88c2d39908e51906440fb17b078133d1f2661d4c4ee8353e1c5483a1e10383',
 'd558dc30e639734b33aef9ecade394506dedeef4a175d5be520d718ed4cacd86',
 '8c245c6f80ed27d6cf97ee63f645034fa964612e58400a5b95e7e5c7059f4e8d',
 'dda1cde1f8a0fcd13a69cc86d344e467722a9f12417198e5dbe92a71e4dbe03d',
 'c385484914b0fbd9df1caf8c7c90f80ac55691c45fc39bd0653a14f2ec5c65fe',
 'b1a5e13898d730f0113fc9d43e1a5b9e105abb5a67c3f3e2633eb3168ee744ef',
 'e771e93c5e60ff225eb9c832d7a7eb4522f03b40a2b9d0a6778b2bf0dc040cff',
 'd4bd53677c5e2ae55e11ffde6810aa4e92555388e0c25292d5d4916acf1262b3',
 '03307e4f952b74c99fddfb5537b589103edaab8e1d602eec9907211ba960378b',
 'a962e0f2ed9563835257a2956b46a1f56aab9f0a1914a381c76e244bb32e3ba6',
 '789c9d7e774aeaadbf12efc1413ec4688132d8e4c876eee8fc8066c83245c5df',
 '965179f973e75a8f9291bb33468fb19b790f79b41e7822a80c079073d285ee85',
 'a87e989b8ebd8fff0826ca78c9710b2ffb7399310e4e9b7a9b072a7991076223',
 '40d2f3882a7aa1c7476d41b7280688336f6a77a74387b8cbf425bae0fd33b45b',
 '06577fd6696584251e69e5ce14d6a730585e754139c54b554be4b28319b232d6',
 '343d981970d9af93bbd69d085f3080b787f0b41771c37ffcdbfaaf625403c978',
 'e651af9d993e0fc93c0f74e21b092b38ddb2083859c9af4a4cf5fe9c3369c2b1',
 '932de6aec82e319aadc6d47f433dd7e29812a69aeff81ddc3bed25c40a039d4a',
 'd89781487a602fb7b64f5eb1ba15cc3703d5c658f9224f44132c26638d04731e',
 '2a7dc02065bdb7e896598c016983831bff0b3309f93111058412a8ff0ef0fe32',
 'c773ac2ac5e1e4bcadc32ffc87c176c327ebdbcdca8de00d0afe9c7c9a238083',
 '83f5bbd7ce614bbb0faf8a0bf519f2e7d419ed42e3a9df4e197ef74c9b2e58cf',
 '2283a5b570c17e818166787ca8701c001187858eb9fc29c3f77889ede8a695de',
 '9b51361211a6491a5591f510c5b12c655ce0226c4775fc656ad2cf5fcc497188',
 'e19d50614b938b26f201fde7da17ddc9decdc531f09b3f4a775ed393190bcf9c',
 'dee1eba38f9b6582c192e6acd7e82acdb92b684a548cb77f56c2e6abb3c7de7b',
 '5ad818b84947547b84c4640d4627b430e1b219705bc99de6d92707e13f5fd647',
 'b8fabfd1a8101b4410aef765c85909b7e4e53d6b9c32933316d91f3e444a0439',
 'd5fc0537ec3998a436295f42abc63dd3412d4b27fe613483171808e596e55e7a',
 '5bf09d2f77c9a591043f52b02269f0a75eee2a02b9b81d34d75eda79a04fb531',
 '12123dd79b5e764dc2e3c7b8562cfc72403bbf7acf58f801c89b241627b8b518',
 'd4aaf2ddd238eec94380db1649c3c3e0ffafae74a716cc9a8a1caeb068b6ea7a',
 '8ab67b03fe1b4f65632f82a90a9db7732d73eb069a670ab994bf4159585b58d2',
 '3990a843754a2d5bc574490f3a267b2ab7d4562f4dbcebd4eb3d10009f95c9e9',
 '8de8d80a33e87205cf381d1cdee62a4b1a68ca7952e94653969c073fa07ec08d',
 '8a18e2aeb6c7ff2c9641f68840260d6487fe6c5fdc7838e753395b09e1a78d66',
 'a22776632437cd216e340025c07589d78d9ef0fccd2e7775d599683e64e1ab7d',
 '187669ef0fc386c3b16bd47bfe444c8888506ed0b2c048384f7e498af20ba826',
 '23695cf31c337d0c73b696235dcd03152bc6427cc8ccdde8e8670f5f27a9dae3']